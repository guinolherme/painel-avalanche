<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle: Operação Avalanche</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap)" rel="stylesheet">
    <script src="[https://cdn.jsdelivr.net/npm/chart.js](https://cdn.jsdelivr.net/npm/chart.js)"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom-color: #4f46e5; color: #4f46e5; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh;
        }
         .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Painel de Controle</h1>
            <p class="text-gray-600 mt-1">Operação Avalanche: Sprint 1</p>
        </header>

        <!-- Navegação por Abas -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-6" id="tabs">
                <button data-tab="dashboard" class="py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-gray-300 tab-active">Visão Geral</button>
                <button data-tab="SG" class="py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-gray-300">Surto Generativo</button>
                <button data-tab="UMC" class="py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-gray-300">Um Minuto de Conhecimento</button>
                <button data-tab="OC" class="py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-gray-300">Oásis Cotidiano</button>
                <button data-tab="BD" class="py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-gray-300">Bestiário Digital</button>
                <button data-tab="FA" class="py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-gray-300">Fábrica de Arrepios</button>
            </nav>
        </div>

        <!-- Conteúdo das Abas -->
        <main id="tab-content">
            <!-- Aba de Visão Geral (Dashboard) -->
            <div id="dashboard-content" class="tab-pane active">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Vídeos Publicados</h3>
                        <p class="mt-1 text-3xl font-semibold text-gray-900" id="kpi-total-videos">0</p>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Views (24h)</h3>
                        <p class="mt-1 text-3xl font-semibold text-gray-900" id="kpi-total-views">0</p>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Novos Seguidores</h3>
                        <p class="mt-1 text-3xl font-semibold text-gray-900" id="kpi-total-followers">0</p>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">Quociente de Viralidade Médio</h3>
                        <p class="mt-1 text-3xl font-semibold text-gray-900" id="kpi-avg-qv">0.00</p>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-medium text-gray-900 mb-4">Performance dos Canais (Views)</h3>
                     <div class="h-96">
                        <canvas id="channelsChart"></canvas>
                     </div>
                </div>
            </div>

            <!-- Abas dos Canais (serão preenchidas dinamicamente) -->
            <div id="SG-content" class="tab-pane hidden"></div>
            <div id="UMC-content" class="tab-pane hidden"></div>
            <div id="OC-content" class="tab-pane hidden"></div>
            <div id="BD-content" class="tab-pane hidden"></div>
            <div id="FA-content" class="tab-pane hidden"></div>
        </main>
    </div>

    <!-- Modal para Detalhes do Vídeo -->
    <div id="video-modal" class="modal-backdrop hidden">
        <div id="modal-content-wrapper" class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl modal-content overflow-y-auto">
            <!-- O conteúdo será injetado aqui -->
        </div>
    </div>
    
    <!-- Modal para Adicionar Dossiê -->
    <div id="dossier-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-2xl p-6">
            <h2 class="text-xl font-bold mb-4">Adicionar Novo Dossiê</h2>
            <p class="text-sm text-gray-600 mb-4">Cole o payload JSON fornecido para criar um novo vídeo para este canal.</p>
            <textarea id="json-payload-input" class="w-full h-48 p-2 border border-gray-300 rounded-md font-mono text-sm" placeholder='{"id": "CANAL_00X", "status": "Para Produzir", ...}'></textarea>
            <div id="json-error" class="text-red-500 text-sm mt-2 hidden">JSON inválido. Por favor, verifique o formato.</div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-dossier-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="save-dossier-button" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js)";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js)";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, setDoc, serverTimestamp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";

        // IMPORTANTE: Substitua os valores abaixo pelos do seu projeto no Firebase
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // VARIÁVEIS GLOBAIS
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-avalanche-app';
        let userId = null;
        let allVideos = [];

        // LÓGICA DE AUTENTICAÇÃO
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                initializeDataListeners();
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Erro no login anônimo:", error);
                });
            }
        });

        // FUNÇÕES DA API DO GEMINI
        async function callGeminiAPI(prompt, systemInstruction = "Você é um especialista em marketing viral para mídias sociais.") {
            const model = "gemini-2.0-flash";
            const chatHistory = [
                { role: "system", parts: [{ text: systemInstruction }] },
                { role: "user", parts: [{ text: prompt }] }
            ];
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Resposta inesperada da API Gemini:", result);
                    return "Erro ao gerar resposta. Tente novamente.";
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                return "Erro de conexão com a API. Verifique o console.";
            }
        }

        // FUNÇÕES AUXILIARES E DE RENDERIZAÇÃO
        function getChannelName(channelCode) {
            const names = {
                SG: 'Surto Generativo',
                UMC: 'Um Minuto de Conhecimento',
                OC: 'Oásis Cotidiano',
                BD: 'Bestiário Digital',
                FA: 'Fábrica de Arrepios'
            };
            return names[channelCode] || 'Desconhecido';
        }
        
        function renderChannelContent(channelCode) {
            const contentDiv = document.getElementById(`${channelCode}-content`);
            if (!contentDiv) return;
            const channelVideos = allVideos.filter(v => v.id.startsWith(channelCode));
            
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">${getChannelName(channelCode)}</h2>
                    <button data-channel-code="${channelCode}" class="add-dossier-button px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium">
                        + Adicionar Dossiê
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            `;

            if (channelVideos.length === 0) {
                 html += `<p class="text-gray-500 col-span-full">Nenhum dossiê encontrado para este canal.</p>`;
            } else {
                channelVideos.sort((a,b) => a.id.localeCompare(b.id)).forEach(video => {
                    html += `
                        <div class="bg-white p-5 rounded-lg shadow cursor-pointer hover:shadow-lg transition-shadow video-card" data-video-id="${video.id}">
                            <h3 class="font-bold text-gray-900 truncate">${video.tituloOtimizado}</h3>
                            <p class="text-sm text-gray-500 mt-1">${video.id}</p>
                            <span class="mt-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${video.status === 'Publicado' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${video.status}
                            </span>
                        </div>
                    `;
                });
            }
            html += `</div>`;
            contentDiv.innerHTML = html;
        }
        
        function renderDashboard() {
            document.getElementById('kpi-total-videos').textContent = allVideos.filter(v => v.status === 'Publicado').length;
            
            const totalViews = allVideos.reduce((acc, v) => acc + (v.views24h || 0), 0);
            document.getElementById('kpi-total-views').textContent = totalViews.toLocaleString('pt-BR');

            const totalFollowers = allVideos.reduce((acc, v) => acc + (v.novosSeguidores || 0), 0);
            document.getElementById('kpi-total-followers').textContent = totalFollowers.toLocaleString('pt-BR');

            const videosWithQv = allVideos.filter(v => v.qv > 0);
            const avgQv = videosWithQv.length > 0 
                ? (videosWithQv.reduce((acc, v) => acc + v.qv, 0) / videosWithQv.length).toFixed(2)
                : '0.00';
            document.getElementById('kpi-avg-qv').textContent = avgQv;

            renderChannelsChart();
        }

        let channelsChartInstance;
        function renderChannelsChart() {
            const ctx = document.getElementById('channelsChart').getContext('2d');
            const channelCodes = ['SG', 'UMC', 'OC', 'BD', 'FA'];
            const labels = channelCodes.map(getChannelName);
            const data = channelCodes.map(code => 
                allVideos
                    .filter(v => v.id.startsWith(code))
                    .reduce((acc, v) => acc + (v.views24h || 0), 0)
            );

            if(channelsChartInstance) {
                channelsChartInstance.destroy();
            }

            channelsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Views (24h)',
                        data: data,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function showModal(content) {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            modalContentWrapper.innerHTML = content;
            document.getElementById('video-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('video-modal').classList.add('hidden');
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            modalContentWrapper.innerHTML = '';
        }

        function renderModalContent(video) {
            return `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                           <h2 class="text-2xl font-bold text-gray-900">${video.tituloOtimizado}</h2>
                           <p class="text-sm text-gray-500">${video.id} - ${getChannelName(video.id.substring(0,2))}</p>
                        </div>
                        <button id="close-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                     <div class="space-y-6">
                        <div>
                            <h3 class="font-semibold text-gray-800 border-b pb-2 mb-3">Estratégia</h3>
                            <p class="text-sm text-gray-700"><strong class="text-gray-600">Racional:</strong> ${video.racionalEstrategico}</p>
                            <p class="text-sm text-gray-700 mt-1"><strong class="text-gray-600">Gatilho Psicológico:</strong> ${video.gatilhoPsicologico}</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 border-b pb-2 mb-3">Roteiro</h3>
                            <div class="bg-gray-50 p-4 rounded-md text-sm text-gray-700 whitespace-pre-wrap" id="roteiro-content">${video.roteiro}</div>
                            <div class="flex justify-end mt-2">
                                <button data-doc-id="${video.docId}" data-field="roteiro" class="gemini-action-button text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md hover:bg-indigo-200">✨ Expandir Roteiro</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 border-b pb-2 mb-3">Títulos e Hashtags</h3>
                            <div class="bg-gray-50 p-4 rounded-md text-sm text-gray-700" id="titulo-content">
                                <p><strong>Título:</strong> ${video.tituloOtimizado}</p>
                                <p class="mt-2"><strong>Hashtags:</strong> ${video.hashtags}</p>
                            </div>
                            <div class="flex justify-end mt-2">
                                <button data-doc-id="${video.docId}" data-field="titulo" class="gemini-action-button text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md hover:bg-indigo-200">✨ Gerar Alternativas</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 border-b pb-2 mb-3">Prompts de Cena (IA)</h3>
                            <div class="bg-gray-50 p-4 rounded-md text-sm text-gray-700 font-mono" id="prompt-content">
                                <p><strong>CENA 1:</strong> ${video.promptCena1}</p>
                                ${video.promptCena2 ? `<p class="mt-2"><strong>CENA 2:</strong> ${video.promptCena2}</p>` : ''}
                            </div>
                             <div class="flex justify-end mt-2">
                                <button data-doc-id="${video.docId}" data-field="prompt" class="gemini-action-button text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md hover:bg-indigo-200">✨ Otimizar Prompts</button>
                            </div>
                        </div>
                        <div id="gemini-output-container" class="hidden">
                             <h3 class="font-semibold text-gray-800 border-b pb-2 mb-3">Sugestão da IA</h3>
                             <div id="gemini-loader" class="loader mx-auto my-4"></div>
                             <div id="gemini-output" class="bg-indigo-50 p-4 rounded-md text-sm text-gray-800 whitespace-pre-wrap"></div>
                             <div id="gemini-action-buttons" class="flex justify-end mt-4 hidden">
                                <button id="save-gemini-output" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm">Salvar Alteração</button>
                             </div>
                        </div>
                    </div>
                </div>`;
        }

        // FUNÇÃO DE INICIALIZAÇÃO E LISTENERS DE UI
        function initializeDataListeners() {
            if (!userId) return;
            const videoCollectionRef = collection(db, `artifacts/${appId}/public/data/videos`);
            onSnapshot(videoCollectionRef, (snapshot) => {
                allVideos = snapshot.docs.map(doc => ({...doc.data(), docId: doc.id}));
                renderAllChannels();
                renderDashboard();
            });
        }
        
        function renderAllChannels() {
             const channelCodes = ['SG', 'UMC', 'OC', 'BD', 'FA'];
             channelCodes.forEach(code => renderChannelContent(code));
        }

        document.getElementById('tabs').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const tab = e.target.dataset.tab;
                
                document.querySelectorAll('#tabs button').forEach(b => b.classList.remove('tab-active'));
                e.target.classList.add('tab-active');

                document.querySelectorAll('#tab-content .tab-pane').forEach(p => p.classList.add('hidden'));
                document.getElementById(`${tab}-content`).classList.remove('hidden');
            }
        });

        document.getElementById('tab-content').addEventListener('click', (e) => {
            const card = e.target.closest('.video-card');
            if (card) {
                const videoId = card.dataset.videoId;
                const video = allVideos.find(v => v.id === videoId);
                if (video) {
                    showModal(renderModalContent(video));
                }
                return;
            }
            
            const addButton = e.target.closest('.add-dossier-button');
            if(addButton) {
                const channelCode = addButton.dataset.channelCode;
                const dossierModal = document.getElementById('dossier-modal');
                dossierModal.dataset.currentChannel = channelCode;
                dossierModal.classList.remove('hidden');
                document.getElementById('json-payload-input').value = '';
                document.getElementById('json-error').classList.add('hidden');
            }
        });
        
        document.getElementById('video-modal').addEventListener('click', async (e) => {
            if (e.target.id === 'close-modal-button' || e.target.closest('#close-modal-button') || e.target.classList.contains('modal-backdrop')) {
                closeModal();
                return;
            }

            const geminiButton = e.target.closest('.gemini-action-button');
            if (geminiButton) {
                const videoId = geminiButton.dataset.docId;
                const field = geminiButton.dataset.field;
                const video = allVideos.find(v => v.docId === videoId);
                
                const container = document.getElementById('gemini-output-container');
                const loader = document.getElementById('gemini-loader');
                const outputDiv = document.getElementById('gemini-output');
                const actionButtons = document.getElementById('gemini-action-buttons');

                container.classList.remove('hidden');
                loader.classList.remove('hidden');
                outputDiv.textContent = '';
                actionButtons.classList.add('hidden');

                let prompt;
                if(field === 'titulo') {
                    prompt = `Com base neste roteiro, gere 5 alternativas de títulos e conjuntos de hashtags para um vídeo curto (TikTok/Shorts). Roteiro: "${video.roteiro}"`;
                } else if (field === 'roteiro') {
                    prompt = `Expanda este roteiro para um vídeo de ~25 segundos, mantendo a essência, mas adicionando mais detalhes e uma narração mais fluida. Roteiro base: "${video.roteiro}"`;
                } else if (field === 'prompt') {
                    prompt = `Otimize estes prompts de IA para gerar imagens cinematográficas e visualmente impressionantes. Mantenha o conceito, mas melhore a direção de arte. Prompts base: CENA 1: ${video.promptCena1}, CENA 2: ${video.promptCena2}`;
                }

                const result = await callGeminiAPI(prompt);
                
                loader.classList.add('hidden');
                outputDiv.textContent = result;
                
                const saveButton = document.getElementById('save-gemini-output');
                saveButton.dataset.docId = videoId;
                saveButton.dataset.field = field;
                saveButton.dataset.content = result;
                actionButtons.classList.remove('hidden');
                return;
            }
            
            const saveGeminiButton = e.target.closest('#save-gemini-output');
            if (saveGeminiButton) {
                const videoId = saveGeminiButton.dataset.docId;
                const field = saveGeminiButton.dataset.field;
                const content = saveGeminiButton.dataset.content;
                const videoRef = doc(db, `artifacts/${appId}/public/data/videos`, videoId);

                let updateData = {};
                // Para simplificar, vamos salvar a sugestão inteira em um campo de notas.
                // O usuário pode copiar e colar manualmente se gostar.
                const fieldMap = {
                    'titulo': 'notas_titulo',
                    'roteiro': 'notas_roteiro',
                    'prompt': 'notas_prompt'
                };
                updateData[fieldMap[field]] = content;
                
                await updateDoc(videoRef, updateData);
                document.getElementById('gemini-output-container').classList.add('hidden');
            }
        });
        
        // CORREÇÃO: Listener para o modal de adicionar dossiê usando delegação de evento.
        document.getElementById('dossier-modal').addEventListener('click', async (e) => {
            // Fecha o modal se clicar no backdrop
            if (e.target.id === 'dossier-modal') {
                e.currentTarget.classList.add('hidden');
                return;
            }
            
            // Botão Cancelar
            const cancelButton = e.target.closest('#cancel-dossier-button');
            if (cancelButton) {
                e.currentTarget.classList.add('hidden');
                return;
            }

            // Botão Salvar
            const saveButton = e.target.closest('#save-dossier-button');
            if (saveButton) {
                const jsonInput = document.getElementById('json-payload-input').value;
                const errorDiv = document.getElementById('json-error');
                const channelCode = e.currentTarget.dataset.currentChannel;

                try {
                    const data = JSON.parse(jsonInput);
                    
                    if (!data.id || !data.tituloOtimizado) {
                        throw new Error("O JSON precisa ter pelo menos os campos 'id' e 'tituloOtimizado'.");
                    }
                    if (!data.id.startsWith(channelCode)) {
                        throw new Error(`O ID "${data.id}" não pertence ao canal ${getChannelName(channelCode)}.`);
                    }

                    const videoRef = doc(db, `artifacts/${appId}/public/data/videos`, data.id);
                    await setDoc(videoRef, { ...data, createdAt: serverTimestamp() });
                    
                    e.currentTarget.classList.add('hidden');
                    errorDiv.classList.add('hidden');

                } catch (err) {
                    errorDiv.textContent = `Erro: ${err.message}`;
                    errorDiv.classList.remove('hidden');
                }
            }
        });

    </script>

</body>
</html>
```
